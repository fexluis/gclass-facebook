<!doctype html>
<html>
<head>
<style>
body {
  font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
  display: flex;
  justify-content: center;
  text-align: center;
}

#loading, #authorize, #choose-course, #flash-card-game { display: none; }

.is-loading #loading { display: block; }
.is-authorizing #authorize { display: block; }
.is-choosing-course #choose-course { display: block; }
.is-playing #flash-card-game { display: block; }

#sign-in {
  padding: 15px 30px;
  margin: 15px;
  text-transform: none;
  font-size: 1rem;
  font-weight: bold;
}

#courses button { width: 200px; }

#courses,
#options {
	position: relative;
    list-style: none;
    padding: 0;
}

#options .option,
#student { width: 150px; }

button {
	text-transform: capitalize;
	border: none;
	border-radius: 5px;
	padding: 5px;
	text-decoration: none;
	font-size: .8em;
	margin: 0 0 10px 0;
	color: #fff;
	position: relative;
	display: inline-block;
	cursor: pointer;
	text-align: center;

	-webkit-transition: background-color 100ms linear;
	-ms-transition: background-color 100ms linear;
	transition: background-color 100ms linear;
}

button:active {
	outline: none;
	transform: translate(0px, 5px);
	-webkit-transform: translate(0px, 5px);
	box-shadow: 0px 1px 0px 0px;
}

button { background-color: #55acee; box-shadow: 0px 5px 0px 0px #3C93D5; }
button:hover { background-color: #6FC6FF; }

.option-picked .correct-answer { background-color: #2ecc71; box-shadow: 0px 5px 0px 0px #15B358; }
.option-picked .correct-answer:hover { background-color: #48E68B; }

.wrong-answer.selected-option { background-color: #e74c3c; box-shadow: 0px 5px 0px 0px #CE3323; }
.wrong-answer.selected-option:hover { background-color: #FF6656; }

.click-catcher {
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	display: none;
	z-index: 1000;
}
.option-picked .click-catcher{ display: block; }
</style>
</head>
<body class="is-loading">
<div id="loading">
    <h1>Loading data...</h1>
</div>
<div id="authorize">
    <button id="sign-in">Sign in with Google Classroom</button>
</div>
<div id="choose-course">
    <h1>Choose a Classroom</h1>
    <ul id="courses"></ul>
</div>
<div id="flash-card-game">
    <h1>Who is this?</h1>
    <img id="student" src="">
    <ul id="options"></ul>
</div>
<script src="https://apis.google.com/js/api.js"></script>
<script>
function authorize(callback) {
	const SCOPES = [
		'https://www.googleapis.com/auth/classroom.courses.readonly',
		'https://www.googleapis.com/auth/classroom.profile.photos',
		'https://www.googleapis.com/auth/classroom.rosters.readonly',
	].join(" ");
	let config = {
		'apiKey': 'AIzaSyDhP7cfYme795mDLjqBrS_lpovY4Imc0Oc',
		'discoveryDocs': [ "https://www.googleapis.com/discovery/v1/apis/classroom/v1/rest" ],
		'clientId': '885544404811-b1a3397hc05c9arjbkupaufg2no1ii8l.apps.googleusercontent.com',
		'scope': SCOPES
	};


	let GoogleAuth;
	let client = {
		user() {
			return GoogleAuth.currentUser.get();
		},
		courses(callback) {
			gapi.client.classroom.courses.list({ pageSize: 100 }).then(
				(res) => callback(null, res.result.courses),
				(err) => callback(err)
			);
		},
		profiles(courseId, callback) {
			let params = { pageSize: 100, courseId: courseId };
			gapi.client.classroom.courses.students.list(params).then(
				(res) => {
					debugger;
					const students = res.result.students.map(student => {
						return {
							name: student.profile.name.fullName,
							photo: student.profile.photoUrl
						};
					});
					callback(null, students);
				},
				(err) => callback(err)
			);
		}
	};

    // Load the API's client and auth2 modules.
    // Call the initClient function after the modules load.
    gapi.load('client:auth2', () => {
        gapi.client.init(config).then(() => {
			GoogleAuth = gapi.auth2.getAuthInstance();

			if (GoogleAuth.isSignedIn.get()) { return callback(null, client); 	}

			document.getElementsByTagName("body")[0].className = "is-authorizing";
			document.getElementById("authorize").addEventListener("click", function(e) {
				GoogleAuth.signIn().then(
					() => {
						var user = GoogleAuth.currentUser.get();
						var isAuthorized = user.hasGrantedScopes(SCOPES);
						if (isAuthorized) {
							return callback(null, client);
						} else {
							document.getElementsByTagName("body")[0].className = "is-authorizing";
							$('#sign-in-or-out-button').html('Sign In/Authorize');
							$('#revoke-access-button').css('display', 'none');
							$('#auth-status').html('You have not authorized this app or you are signed out.');
						}
						debugger;
					},
					() => {
						debugger;
					}
				);
			});
        });
    });
}

function createGame(profiles) {
    let students = profiles.map(p => p.name);
    let pool = [];

    function renderOptions(options, correctAnswer) {
        document.getElementById("options").className = "";

        let html = options.map(function(opt) {
            let btnClass = (opt === correctAnswer ? "correct-answer" : "wrong-answer");
            return "<li><button class='option " + btnClass + "'>" + opt + "</button></li>";
        }).join("") + "<div class='click-catcher'/>";

        document.getElementById("options").innerHTML = html;
    }

    function nextQuestion() {
        if(pool.length < 1) { pool = students.slice(0); /* clones array */ }

        let idx = Math.random() * pool.length | 0;
        let student = pool.splice(idx, 1)[0];
        document.getElementById("student").src = profiles.find(p => p.name == student).photo;

        let options = [ student ];
        while(options.length < 5 && options.length < students.length) {
            let option = students[Math.random() * students.length | 0];

            if(options.indexOf(option) === -1) {
                options.splice(Math.random() * (options.length + 1) | 0, 0, option); // Random insert
            }
        }

        renderOptions(options, student);
    }

    document.getElementById("options").addEventListener("click", function(e) {
        if(e.target.className.indexOf("option") === -1) { return; }

        e.preventDefault();
        e.target.className += " selected-option";

        document.getElementById("options").className = "option-picked";
        setTimeout(nextQuestion, 1000);
    }, false);

    return { nextQuestion };
}

function displayCourseChooser(courses, callback) {
    let html = courses.map(course => {
        return "<li><a class='option' href='" + course.url +
            "' data-course-id='" + course.id + "'>" + course.name +
        "</a></li>";
    }).join("");

    document.getElementById("courses").innerHTML = html;
    document.getElementById("courses").addEventListener("click", function(e) {
        if(e.target.className.indexOf("option") === -1) { return; }

        e.preventDefault();
        e.target.className += " selected-option";

        callback(null, e.target.dataset["courseId"]);
    }, false);

}

document.getElementsByTagName("body")[0].className = "is-loading";
authorize((err, client) => {
	if(err) { return alert(err); }

	document.getElementsByTagName("body")[0].className = "is-loading";

	client.courses((err, courses) => {
		if(err) { return alert(err); }

		document.getElementsByTagName("body")[0].className = "is-choosing-course";

		displayCourseChooser(courses, (err, courseId) => {
			if(err) { return alert(err); }

			document.getElementsByTagName("body")[0].className = "is-loading";

			client.profiles(courseId, (err, profiles) => {
				document.getElementsByTagName("body")[0].className = "is-playing";

				let game = createGame(profiles);
				game.nextQuestion();
			});
		});
	});
});
</script>
</body>
</html>
