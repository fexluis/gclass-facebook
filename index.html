
<!doctype html>
<html>
<head>
<style>
body {
  font-family: Arial,"Helvetica Neue",Helvetica,sans-serif;
}

.is-loading #loading { display: block; }
.is-loading #flash-card-game,
.is-loading #choose-course { display: none; }

.is-choosing-course #choose-course { display: block; }
.is-choosing-course #loading,
.is-choosing-course #flash-card-game { display: none; }

.is-playing #flash-card-game { display: block; }
.is-playing #loading,
.is-playing #choose-course { display: none; }


#student { width: 150px; padding: 0 5px; }

#courses a { width: 200px; }

#courses,
#options {
	position: relative;
    list-style: none;
    padding: 0;
}

.option {
	text-transform: capitalize;
	border-radius: 5px;
	padding: 5px;
	text-decoration: none;
	margin: 0 0 10px 0;
	color: #fff;
	position: relative;
	display: inline-block;
	width: 150px;
	cursor: pointer;
	text-align: center;

	-webkit-transition: background-color 100ms linear;
	-ms-transition: background-color 100ms linear;
	transition: background-color 100ms linear;
}

.option:active {
	transform: translate(0px, 5px);
	-webkit-transform: translate(0px, 5px);
	box-shadow: 0px 1px 0px 0px;
}

.option { background-color: #55acee; box-shadow: 0px 5px 0px 0px #3C93D5; }
.option:hover { background-color: #6FC6FF; }

.option-picked .correct-answer { background-color: #2ecc71; box-shadow: 0px 5px 0px 0px #15B358; }
.option-picked .correct-answer:hover { background-color: #48E68B; }

.wrong-answer.selected-option { background-color: #e74c3c; box-shadow: 0px 5px 0px 0px #CE3323; }
.wrong-answer.selected-option:hover { background-color: #FF6656; }

.click-catcher {
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	display: none;
	z-index: 1000;
}
.option-picked .click-catcher{ display: block; }
</style>
</head>
<body class="is-loading">
<div id="loading">
    <h1>Loading data...</h1>
</div>
<div id="choose-course">
    <h1>Choose a Classroom</h1>
    <ul id="courses"></ul>
</div>
<div id="flash-card-game">
    <h1>Who is this?</h1>
    <img id="student" src="">
    <ul id="options"></ul>
</div>
<script>
function createGame(photos) {
    let students = photos.map(p => p.name);
    let pool = [];

    function renderOptions(options, correctAnswer) {
        document.getElementById("options").className = "";

        let html = options.map(function(opt) {
            let btnClass = (opt === correctAnswer ? "correct-answer" : "wrong-answer");
            return "<li><a class='option " + btnClass + "'>" + opt + "</a></li>";
        }).join("") + "<div class='click-catcher'/>";

        document.getElementById("options").innerHTML = html;
    }

    function nextQuestion() {
        if(pool.length < 1) { pool = students.slice(0); /* clones array */ }

        let idx = Math.random() * pool.length | 0;
        let student = pool.splice(idx, 1)[0];
        document.getElementById("student").src = photos.find(p => p.name == student).photo;

        let options = [ student ];
        while(options.length < 5 && options.length < students.length) {
            let option = students[Math.random() * students.length | 0];

            if(options.indexOf(option) === -1) {
                options.splice(Math.random() * (options.length + 1) | 0, 0, option); // Insert randomly
            }
        }

        renderOptions(options, student);
    }

    document.getElementById("options").addEventListener("click", function(e) {
        if(e.target.className.indexOf("option") === -1) { return; }

        e.preventDefault();
        e.target.className += " selected-option";

        document.getElementById("options").className = "option-picked";
        setTimeout(nextQuestion, 1000);
    }, false);

    return { nextQuestion };
}

function displayCourseChooser(courses, callback) {
    let html = courses.map(course => {
        return "<li><a class='option' href='" + course.url +
            "' data-course-id='" + course.id + "'>" + course.name +
        "</a></li>";
    }).join("");

    document.getElementById("courses").innerHTML = html;
    document.getElementById("courses").addEventListener("click", function(e) {
        if(e.target.className.indexOf("option") === -1) { return; }

        e.preventDefault();
        e.target.className += " selected-option";

        callback(null, e.target.dataset["courseId"]);
    }, false);

}

function makeGetRequest(url, cb) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.onload = function() {
        if (xhr.status !== 200) { return cb(new Error(xhr.status + " -- " + xhr.responseText)); }

        cb(null, JSON.parse(xhr.responseText));
    };
    xhr.send();
}

document.getElementsByTagName("body")[0].className = "is-loading";
makeGetRequest("/courses", (err, courses) => {
    if(err) { return alert(err); }

    document.getElementsByTagName("body")[0].className = "is-choosing-course";

    displayCourseChooser(courses, (err, courseId) => {
        if(err) { return alert(err); }

        document.getElementsByTagName("body")[0].className = "is-loading";

        makeGetRequest("/photos?course_id=" + courseId, (err, photos) => {
            document.getElementsByTagName("body")[0].className = "is-playing";

            let game = createGame(photos);
            game.nextQuestion();
        });
    });
});

</script>
</body>
</html>
